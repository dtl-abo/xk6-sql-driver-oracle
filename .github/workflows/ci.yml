name: CI

on:
  workflow_dispatch:
  push:
    branches: ["main", "master"]
    tags: ["v*"]
  pull_request:

jobs:
  build-with-xk6:
    runs-on: ubuntu-latest
    services:

      # Oracle service (label used to access the service container)
      oracle:

        # Docker Hub image (feel free to change the tag "latest" to any other available one)
        image: gvenzl/oracle-free:slim-faststart

        # Provide passwords and other environment variables to container
        env:
          ORACLE_PASSWORD: mypassword
          APP_USER: my_user
          APP_USER_PASSWORD: password_i_should_change

        # Forward Oracle port
        ports:
          - 1521:1521

        # Provide healthcheck script options for startup
        options: >-
          --health-cmd healthcheck.sh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.22.x
      - name: Install xk6
        run: go install go.k6.io/xk6/cmd/xk6@latest
      - name: Build
        run: make build
      - name: Test
        run: |
          # Wait for Oracle to be ready
          # echo "Waiting for Oracle to start..."
          # sleep 120 # Increase if necessary
          # debug dns issue
          # ping oracle -c 4
          make test
